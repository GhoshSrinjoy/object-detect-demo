<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Object Detection (Browser)</title>
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--ring:#22d3ee}
    *{box-sizing:border-box}
    body{margin:0;background:#0b1220;color:#e5e7eb;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:10px 14px;border-bottom:1px solid #1f2937;background:#0f172a}
    .wrap{max-width:920px;margin:16px auto;padding:0 12px;display:grid;gap:12px}
    .panel{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{cursor:pointer;border:1px solid #374151;background:#111827;color:#e5e7eb;border-radius:10px;padding:8px 12px;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    #stage{position:relative;aspect-ratio:4/3;max-width:900px;width:100%;border-radius:12px;overflow:hidden;border:1px solid #1f2937;background:#0b1220}
    video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:contain}
    .badge{padding:2px 8px;border-radius:999px;background:#111827;border:1px solid #374151;color:#93c5fd}
  </style>
  <!-- Pinned TFJS + COCO-SSD UMD bundles -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.16.0/dist/tf-backend-webgl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
</head>
<body>
  <header><strong>Object Detection (Client-side)</strong></header>

  <main class="wrap">
    <div class="panel row">
      <button id="start">Start camera</button>
      <button id="stop" disabled>Stop</button>
      <span class="badge">Runs in your browser (WebGL)</span>
      <span id="status" class="badge" style="color:#34d399;border-color:#14532d;background:#052e2b">ready</span>
    </div>

    <div id="stage" class="panel">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
    </div>

    <div class="panel" style="color:#93c5fd">
      Tip: GitHub Pages serves over HTTPS, so the webcam prompt works. On iOS/Safari you must click “Start camera” (autoplay requires a gesture).
    </div>
  </main>

<script>
(async function(){
  const $ = id => document.getElementById(id);
  const video = $('video');
  const canvas = $('overlay');
  const ctx = canvas.getContext('2d');
  const startBtn = $('start');
  const stopBtn = $('stop');
  const status = $('status');

  let stream = null, model = null, running = false;

  function setStatus(s, ok=true){
    status.textContent = s;
    status.style.color = ok ? '#34d399' : '#fda4af';
    status.style.borderColor = ok ? '#14532d' : '#7f1d1d';
    status.style.background = ok ? '#052e2b' : '#2b0b0b';
  }

  function resizeCanvas(){
    const r = video.getBoundingClientRect();
    canvas.width = video.videoWidth || r.width;
    canvas.height = video.videoHeight || r.height;
  }

  async function ensureModel(){
    if (model) return model;
    setStatus('loading model…');
    await tf.setBackend('webgl'); // fastest broadly supported
    await tf.ready();
    model = await cocoSsd.load({base: 'lite_mobilenet_v2'}); // small + fast
    setStatus('model loaded ✓');
    return model;
  }

  async function start(){
    try{
      startBtn.disabled = true;
      await ensureModel();
      setStatus('requesting camera…');
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      await new Promise(res => video.onloadedmetadata = res);
      resizeCanvas();
      running = true;
      stopBtn.disabled = false;
      setStatus('running');
      loop();
    }catch(err){
      console.error(err);
      setStatus('camera denied / unavailable', false);
      startBtn.disabled = false;
    }
  }

  function stop(){
    running = false;
    stopBtn.disabled = true;
    startBtn.disabled = false;
    if (stream){
      for (const t of stream.getTracks()) t.stop();
      stream = null;
    }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    setStatus('stopped');
  }

  async function loop(){
    if (!running || !model) return;
    // keep canvas in sync if camera changed size
    if (canvas.width !== video.videoWidth) resizeCanvas();

    const preds = await model.detect(video); // [{bbox:[x,y,w,h],score,class},...]
    draw(preds);
    requestAnimationFrame(loop);
  }

  function draw(preds){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.lineWidth = Math.max(2, canvas.width/400);
    ctx.font = `bold ${Math.max(12, canvas.width/45)}px system-ui`;

    preds.forEach(p => {
      if (p.score < 0.5) return;
      const [x,y,w,h] = p.bbox;
      // box
      ctx.strokeStyle = '#22d3ee';
      ctx.shadowColor = '#22d3ee';
      ctx.shadowBlur = 6;
      ctx.strokeRect(x, y, w, h);
      ctx.shadowBlur = 0;
      // label bg
      const label = `${p.class} ${(p.score*100|0)}%`;
      const tw = ctx.measureText(label).width + 10;
      const th = parseInt(ctx.font,10) + 6;
      ctx.fillStyle = 'rgba(2,6,23,0.85)';
      ctx.fillRect(x, Math.max(0,y-th), tw, th);
      // text
      ctx.fillStyle = '#e5e7eb';
      ctx.fillText(label, x+5, Math.max(th-4,y-4));
    });
  }

  window.addEventListener('resize', resizeCanvas);
  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
})();
</script>
</body>
</html>
